<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>产品和配方管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">
<h1>产品和配方管理</h1>
<a th:href="@{/}" class="btn btn-secondary mb-3">返回首页</a>
<a th:href="@{/product-category}" class="btn btn-secondary mb-3">切换到产品类别管理</a>

<!-- 产品管理部分 -->
<h2>产品管理</h2>
<table class="table table-bordered">
    <thead>
    <tr>
        <th>ID</th>
        <th>名称</th>
        <th>描述</th>
        <th>类别</th>
        <th>价格</th>
        <th>单位</th>
        <th>库存</th>
        <th>库存状态</th>
        <th>操作</th>
    </tr>
    </thead>
    <tbody id="productTableBody">
    <!-- 动态生成 -->
    </tbody>
</table>
<button class="btn btn-success" onclick="showAddProductForm()">添加产品</button>

<!-- 添加/编辑产品表单 -->
<div id="productForm" style="display:none;">
    <h2 id="formTitle">添加产品</h2>
    <form id="productFormElement">
        <input type="hidden" id="productId">
        <div class="mb-3">
            <label for="name" class="form-label">名称</label>
            <input type="text" class="form-control" id="name" required>
        </div>
        <div class="mb-3">
            <label for="description" class="form-label">描述</label>
            <textarea class="form-control" id="description" required></textarea>
        </div>
        <div class="mb-3">
            <label for="category" class="form-label">类别</label>
            <select class="form-control" id="category">
                <!-- 动态生成 -->
            </select>
        </div>
        <div class="mb-3">
            <label for="price" class="form-label">价格</label>
            <input type="number" class="form-control" id="price" required>
        </div>
        <div class="mb-3">
            <label for="unit" class="form-label">单位</label>
            <input type="text" class="form-control" id="unit" required>
        </div>
        <button type="submit" class="btn btn-primary">保存</button>
        <button type="button" class="btn btn-secondary" onclick="hideProductForm()">取消</button>
    </form>
</div>

<!-- 配方管理部分 -->
<div id="recipeManagement" style="display:none;">
    <h2>配方管理</h2>
    <table class="table table-bordered">
        <thead>
        <tr>
            <th>组件名称</th>
            <th>数量</th>
            <th>单位</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody id="productComponentTableBody">
        <!-- 动态生成 -->
        </tbody>
    </table>
    <button class="btn btn-success" onclick="showAddProductComponentForm()">添加配方</button>
    <button class="btn btn-secondary" onclick="hideRecipeManagement()">取消</button>

    <!-- 添加/编辑配方表单 -->
    <div id="productComponentForm" style="display:none;">
        <h2 id="productComponentFormTitle">添加配方</h2>
        <form id="productComponentFormElement">
            <input type="hidden" id="productComponentId">
            <input type="hidden" id="product">
            <div class="mb-3">
                <label for="component" class="form-label">组件</label>
                <select class="form-control" id="component" required>
                    <!-- 动态生成 -->
                </select>
            </div>
            <div class="mb-3">
                <label for="quantity" class="form-label">数量</label>
                <input type="number" class="form-control" id="quantity" required>
            </div>
            <div class="mb-3">
                <label for="unit" class="form-label">单位</label>
                <input type="text" class="form-control" id="unit" required>
            </div>
            <button type="submit" class="btn btn-primary">保存</button>
            <button class="btn btn-secondary" onclick="hideProductComponentForm()">取消</button>
        </form>
    </div>
</div>

<!-- 库存管理部分 -->
<div id="inventoryManagement" style="display:none;">
    <h2>管理库存</h2>
    <div class="mb-3" id="increaseInventoryDiv" style="display:none;">
        <label for="increaseInventoryQuantity" class="form-label">增加库存数量</label>
        <input type="number" class="form-control" id="increaseInventoryQuantity">
    </div>
    <div class="mb-3" id="decreaseInventoryDiv" style="display:none;">
        <label for="decreaseInventoryQuantity" class="form-label">减少库存数量</label>
        <input type="number" class="form-control" id="decreaseInventoryQuantity">
    </div>
    <button class="btn btn-primary" onclick="showIncreaseInventory()">增加库存</button>
    <button class="btn btn-primary" onclick="showDecreaseInventory()">减少库存</button>
    <button class="btn btn-primary" onclick="saveChanges()">保存更改</button>
    <button class="btn btn-secondary" onclick="hideInventoryManagement()">取消</button>
</div>

<!-- 库存告警值设定部分 -->
<div id="alertThresholdManagement" style="display:none;">
    <h2>设置库存告警值</h2>
    <div class="mb-3">
        <label for="alertThreshold" class="form-label">库存告警值</label>
        <input type="number" class="form-control" id="alertThreshold">
    </div>
    <button class="btn btn-primary" onclick="updateAlertThreshold()">保存更改</button>
    <button class="btn btn-secondary" onclick="hideAlertThresholdManagement()">取消</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fetch and display products
        fetch('/products')
            .then(response => response.json())
            .then(products => {
                const tableBody = document.getElementById('productTableBody');
                tableBody.innerHTML = '';
                products.forEach(product => {
                    fetch(`/inventory/${product.productId}`)
                        .then(response => response.json())
                        .then(inventory => {
                            const inventoryStatus = inventory.quantity < inventory.alertThreshold ? '告警' : '正常';
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${product.productId}</td>
                                <td>${product.name}</td>
                                <td>${product.description}</td>
                                <td>${product.category ? product.category.categoryName : '无'}</td>
                                <td>${product.price}</td>
                                <td>${product.unit}</td>
                                <td>${inventory.quantity}</td>
                                <td>${inventoryStatus}</td>
                                <td>
                                    <button class="btn btn-primary" onclick="manageRecipe(${product.productId})">管理配方</button>
                                    <button class="btn btn-warning" onclick="editProduct(${product.productId})">编辑</button>
                                    <button class="btn btn-danger" onclick="deleteProduct(${product.productId})">删除</button>
                                    <button class="btn btn-primary" onclick="showInventoryManagement(${product.productId})">管理库存</button>
                                    <button class="btn btn-primary" onclick="showAlertThresholdManagement(${product.productId})">设置库存告警值</button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                });
            });

        // Fetch categories for product form
        fetch('/product-categories')
            .then(response => response.json())
            .then(categories => {
                const categorySelect = document.getElementById('category');
                categorySelect.innerHTML = '<option value="">无</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.categoryId;
                    option.text = category.categoryName;
                    categorySelect.appendChild(option);
                });
            });

        // Fetch components for product component form
        fetch('/products')
            .then(response => response.json())
            .then(components => {
                const componentSelect = document.getElementById('component');
                componentSelect.innerHTML = '';
                components.forEach(component => {
                    const option = document.createElement('option');
                    option.value = component.productId;
                    option.text = component.name;
                    componentSelect.appendChild(option);
                });
            });
    });

    // Product form functions
    function showAddProductForm() {
        document.getElementById('formTitle').innerText = '添加产品';
        document.getElementById('productFormElement').reset();
        document.getElementById('productId').value = '';
        document.getElementById('productForm').style.display = 'block';
    }

    function hideProductForm() {
        document.getElementById('productForm').style.display = 'none';
    }

    function editProduct(id) {
        fetch(`/products/${id}`)
            .then(response => response.json())
            .then(product => {
                document.getElementById('formTitle').innerText = '编辑产品';
                document.getElementById('productId').value = product.productId;
                document.getElementById('name').value = product.name;
                document.getElementById('description').value = product.description;
                document.getElementById('category').value = product.category ? product.category.categoryId : '';
                document.getElementById('price').value = product.price;
                document.getElementById('unit').value = product.unit;
                document.getElementById('productForm').style.display = 'block';
            });
    }

    function deleteProduct(id) {
        fetch(`/products/${id}`, {
            method: 'DELETE'
        }).then(response => {
            if (!response.ok) {
                return response.text().then(text => { throw new Error(text) });
            }
            window.location.reload();
        }).catch(error => {
            alert(error.message);
        });
    }

    document.getElementById('productFormElement').addEventListener('submit', function(event) {
        event.preventDefault();
        const id = document.getElementById('productId').value;
        const name = document.getElementById('name').value;
        const description = document.getElementById('description').value;
        const category = document.getElementById('category').value;
        const price = document.getElementById('price').value;
        const unit = document.getElementById('unit').value;

        const method = id ? 'PUT' : 'POST';
        const url = id ? `/products/${id}` : '/products';

        const data = { name, description, price, unit };
        if (category) {
            data.category = { categoryId: category };
        }

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        }).then(() => {
            window.location.reload();
        });
    });

    // Product component form functions
    function showAddProductComponentForm() {
        document.getElementById('productComponentFormTitle').innerText = '添加配方';
        document.getElementById('productComponentFormElement').reset();
        document.getElementById('productComponentId').value = '';
        document.getElementById('productComponentForm').style.display = 'block';
    }

    function hideProductComponentForm() {
        document.getElementById('productComponentForm').style.display = 'none';
    }

    function manageRecipe(productId) {
        document.getElementById('product').value = productId;
        fetch(`/products/${productId}/components`)
            .then(response => response.json())
            .then(components => {
                const tableBody = document.getElementById('productComponentTableBody');
                tableBody.innerHTML = '';
                components.forEach(component => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${component.component.name}</td>
                        <td>${component.quantity}</td>
                        <td>${component.unit}</td>
                        <td>
                            <button class="btn btn-warning" onclick="editProductComponent(${component.product.productId}, ${component.component.productId})">编辑</button>
                            <button class="btn btn-danger" onclick="deleteProductComponent(${component.product.productId}, ${component.component.productId})">删除</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                document.getElementById('recipeManagement').style.display = 'block';
            });
    }

    function hideRecipeManagement() {
        document.getElementById('recipeManagement').style.display = 'none';
    }

    function editProductComponent(productId, componentId) {
        fetch(`/product-components/product/${productId}/component/${componentId}`)
            .then(response => response.json())
            .then(pc => {
                document.getElementById('productComponentFormTitle').innerText = '编辑配方';
                document.getElementById('productComponentId').value = pc.productComponentId;
                document.getElementById('product').value = pc.product.productId;
                document.getElementById('component').value = pc.component.productId;
                document.getElementById('quantity').value = pc.quantity;
                document.getElementById('unit').value = pc.unit;
                document.getElementById('productComponentForm').style.display = 'block';
            });
    }

    function deleteProductComponent(productId, componentId) {
        fetch(`/product-components/product/${productId}/component/${componentId}`, {
            method: 'DELETE'
        }).then(() => {
            window.location.reload();
        });
    }

    document.getElementById('productComponentFormElement').addEventListener('submit', function(event) {
        event.preventDefault();
        const productId = document.getElementById('product').value;
        const componentId = document.getElementById('component').value;
        const quantity = document.getElementById('quantity').value;
        const unit = document.getElementById('unit').value;

        const method = 'POST';
        const url = `/product-components`;

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ product: { productId }, component: { productId: componentId }, quantity, unit })
        }).then(() => {
            window.location.reload();
        });
    });

    // Inventory functions
    function showInventoryManagement(productId) {
        document.getElementById('inventoryManagement').style.display = 'block';
        document.getElementById('inventoryManagement').dataset.productId = productId;
    }

    function hideInventoryManagement() {
        document.getElementById('inventoryManagement').style.display = 'none';
        document.getElementById('increaseInventoryDiv').style.display = 'none';
        document.getElementById('decreaseInventoryDiv').style.display = 'none';
    }

    function showIncreaseInventory() {
        document.getElementById('increaseInventoryDiv').style.display = 'block';
        document.getElementById('decreaseInventoryDiv').style.display = 'none';
    }

    function showDecreaseInventory() {
        document.getElementById('increaseInventoryDiv').style.display = 'none';
        document.getElementById('decreaseInventoryDiv').style.display = 'block';
    }

    function saveChanges() {
        const productId = document.getElementById('inventoryManagement').dataset.productId;
        const increaseQuantity = document.getElementById('increaseInventoryQuantity').value;
        const decreaseQuantity = document.getElementById('decreaseInventoryQuantity').value;

        if (increaseQuantity) {
            fetch(`/inventory/${productId}/adjust?quantity=${increaseQuantity}`, {
                method: 'PUT'
            }).then(() => {
                window.location.reload();
            });
        } else if (decreaseQuantity) {
            fetch(`/inventory/${productId}/adjust?quantity=${-decreaseQuantity}`, {
                method: 'PUT'
            }).then(() => {
                window.location.reload();
            });
        }
    }

    function showAlertThresholdManagement(productId) {
        document.getElementById('alertThresholdManagement').style.display = 'block';
        document.getElementById('alertThresholdManagement').dataset.productId = productId;
        fetch(`/inventory/${productId}`)
            .then(response => response.json())
            .then(inventory => {
                document.getElementById('alertThreshold').value = inventory.alertThreshold;
            });
    }

    function hideAlertThresholdManagement() {
        document.getElementById('alertThresholdManagement').style.display = 'none';
    }

    function updateAlertThreshold() {
        const productId = document.getElementById('alertThresholdManagement').dataset.productId;
        const alertThreshold = document.getElementById('alertThreshold').value;

        fetch(`/inventory/${productId}/alert-threshold?alertThreshold=${alertThreshold}`, {
            method: 'PUT'
        }).then(() => {
            window.location.reload();
        });
    }
</script>
</body>
</html>