<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>客户管理</title>
    <link th:href="@{/css/rolepermission.css}" rel="stylesheet">
    <link th:href="@{/css/sidebar.css}" rel="stylesheet">
    <script th:src="@{/js/sidebar.js}"></script>
</head>
<body>
<div class="container">
    <div class="menu-icon" onclick="toggleSidebar()">☰</div>
    <!-- 侧边栏 -->
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <!-- 右侧内容区 -->
    <div class="content">
        <h1>客户管理</h1>
        <button class="btn btn-primary mb-3" onclick="showAddModal()">添加客户</button>

        <div class="mt-4">
            <h2>客户列表</h2>
            <ul id="customerList" class="list-group"></ul>
        </div>

        <!-- 添加/编辑客户模态框 -->
        <div id="customerModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2 id="modalTitle">添加客户</h2>
                <form id="customerForm">
                    <input type="hidden" id="editCustomerId">
                    <div class="mb-3">
                        <label for="customerName" class="form-label">客户名称:</label>
                        <input type="text" id="customerName" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="contactPerson" class="form-label">联系人:</label>
                        <input type="text" id="contactPerson" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">电话:</label>
                        <input type="text" id="phone" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label">地址:</label>
                        <input type="text" id="address" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary">保存</button>
                </form>
            </div>
        </div>

        <!-- 删除确认模态框（与role.html一致） -->
        <div id="deleteConfirmationModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeDeleteModal()">&times;</span>
                <h2>确认删除</h2>
                <p>您确定要删除此客户吗？</p>
                <div class="modal-actions">
                    <button class="btn btn-danger" onclick="confirmDelete()">确认删除</button>
                    <button class="btn btn-secondary" onclick="closeDeleteModal()">取消</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    let currentDeleteId = null; // 用于暂存待删除的客户ID

    // 显示添加模态框
    function showAddModal() {
        document.getElementById('modalTitle').textContent = '添加客户';
        // 强制清空隐藏 ID，即使从未编辑过
        document.getElementById('editCustomerId').value = '';
        document.getElementById('customerForm').reset();
        document.getElementById('customerModal').style.display = 'block';
    }

    // 显示编辑模态框数据回填
    function editCustomer(customerId) {
        fetch(`/customers/${customerId}`)
            .then(response => response.json())
            .then(customer => {
                document.getElementById('modalTitle').textContent = '编辑客户';
                document.getElementById('editCustomerId').value = customer.customerId;
                document.getElementById('customerName').value = customer.name;
                document.getElementById('contactPerson').value = customer.contactPerson
                document.getElementById('phone').value = customer.phone;
                document.getElementById('address').value = customer.address;
                document.getElementById('customerModal').style.display = 'block';
            });
    }

    // 关闭模态框
    function closeModal() {
        // 清空隐藏的 ID 字段
        document.getElementById('editCustomerId').value = '';
        // 重置表单
        document.getElementById('customerForm').reset();
        // 关闭模态框
        document.getElementById('customerModal').style.display = 'none';
    }

    // 删除确认弹窗
    function showDeleteConfirmation(customerId) {
        currentDeleteId = customerId;
        document.getElementById('deleteConfirmationModal').style.display = 'block';
    }

    function closeDeleteModal() {
        document.getElementById('deleteConfirmationModal').style.display = 'none';
    }

    function confirmDelete() {
        if (currentDeleteId) {
            fetch(`/customers/${currentDeleteId}`, {
                method: 'DELETE'
            }).then(() => {
                window.location.reload();
                closeDeleteModal();
            });
        }
    }

    // 表单提交处理
    document.getElementById('customerForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const customerId = document.getElementById('editCustomerId').value;
        const url = customerId ? `/customers/${customerId}` : '/customers';
        const method = customerId ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: document.getElementById('customerName').value,
                contactPerson: document.getElementById('contactPerson').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value
            })
        }).then(() => {
            window.location.reload();
        });
    });

    // 列表渲染（新增删除函数绑定）
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/customers/list')
            .then(response => response.json())
            .then(customers => {
                const list = document.getElementById('customerList');
                list.innerHTML = '';
                customers.forEach(customer => {
                    const item = document.createElement('li');
                    item.className = 'list-group-item';
                    item.innerHTML = `
                        ${customer.name} - ${customer.contactPerson} - ${customer.phone} - ${customer.address}
                        <div class="btn-container">
                            <button class="btn btn-warning" onclick="editCustomer(${customer.customerId})">编辑</button>
                            <button class="btn btn-danger" onclick="showDeleteConfirmation(${customer.customerId})">删除</button>
                        </div>
                    `;  // 修改此处绑定删除确认
                    list.appendChild(item);
                });
            });
    });
</script>
</body>
</html>

