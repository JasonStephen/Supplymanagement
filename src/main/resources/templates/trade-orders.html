<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>订单管理</title>
    <link th:href="@{/css/trades.css}" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/navigation-bar.css}">
    <script th:src="@{/js/navigation-bar.js}"></script>
</head>
<body>
<div th:replace="~{fragments/navigation-bar :: navigation-bar}"></div>

<div  class="container">
    <h1>订单管理</h1>
    <a th:href="@{/trade}" class="btn btn-return">返回</a>

    <!-- 搜索、筛选、排序区域 -->
    <div class="filters">
        <input type="text" id="searchOrderId" placeholder="搜索订单ID">
        <select id="orderTypeFilter">
            <option value="">订单类型</option>
            <option value="采购订单">采购订单</option>
            <option value="销售订单">销售订单</option>
        </select>
    </div>

    <!-- 订单列表 -->
    <div class="order-header">
        <span>物流订单ID</span>
        <span>订单类型</span>
        <span>客户/供应商</span>
        <span>产品</span>
        <span>数量</span>
        <span>单价</span>
        <span>总价</span>
        <span>物流状态</span>
        <span>订单状态</span>
        <span>操作</span>
    </div>
    <div class="order-list" id="orderList">
        <!-- 动态生成 -->
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/logistics-orders')
            .then(response => response.json())
            .then(logisticsOrders => {
                const orderList = document.getElementById('orderList');
                orderList.innerHTML = '';
                logisticsOrders.forEach(logisticsOrder => {
                    const isPurchaseOrder = logisticsOrder.purchaseOrderId !== null;
                    const isSalesOrder = logisticsOrder.salesOrderId !== null;
                    let orderType = '';
                    let customerOrSupplierName = '';
                    let productName = '';
                    let quantity = '';
                    let unitPrice = '';
                    let totalPrice = '';
                    let orderStatus = '';

                    if (isPurchaseOrder) {
                        orderType = '采购订单';
                        const purchaseOrder = logisticsOrder.purchaseOrder;
                        customerOrSupplierName = purchaseOrder.supplier ? purchaseOrder.supplier.name : 'N/A';
                        productName = purchaseOrder.product ? purchaseOrder.product.name : 'N/A';
                        quantity = purchaseOrder.quantity;
                        unitPrice = purchaseOrder.unitPrice;
                        totalPrice = purchaseOrder.totalPrice;
                        orderStatus = purchaseOrder.status;
                    } else if (isSalesOrder) {
                        orderType = '销售订单';
                        const salesOrder = logisticsOrder.salesOrder;
                        customerOrSupplierName = salesOrder.customer ? salesOrder.customer.name : 'N/A';
                        productName = salesOrder.product ? salesOrder.product.name : 'N/A';
                        quantity = salesOrder.quantity;
                        unitPrice = salesOrder.unitPrice;
                        totalPrice = salesOrder.totalPrice;
                        orderStatus = salesOrder.status;
                    }

                    const orderItem = document.createElement('div');
                    orderItem.className = 'order-item';
                    orderItem.innerHTML = `
                            <div>
                                <span>${logisticsOrder.logisticsOrderId}</span>
                                <span>${orderType}</span>
                                <span>${customerOrSupplierName}</span>
                                <span>${productName}</span>
                                <span>${quantity}</span>
                                <span>${unitPrice}</span>
                                <span>${totalPrice}</span>
                                <span>${logisticsOrder.status}</span>
                                <span>${orderStatus}</span>
                                <span>
                                    ${isPurchaseOrder && logisticsOrder.status === '2' ? `<button class="btn btn-action" onclick="confirmReceipt(${logisticsOrder.logisticsOrderId}, ${logisticsOrder.purchaseOrderId})">签收</button>` : ''}
                                </span>
                            </div>
                        `;
                    orderList.appendChild(orderItem);
                });
            })
            .catch(error => console.error('Error fetching logistics orders:', error));
    });

    function confirmReceipt(logisticsOrderId, purchaseOrderId) {
        fetch(`/logistics-orders/${logisticsOrderId}/confirm-receipt`, {
            method: 'POST'
        }).then(response => {
            if (response.ok) {
                fetch(`/purchase-orders/${purchaseOrderId}/confirm-receipt`, {
                    method: 'POST'
                }).then(() => {
                    window.location.reload();
                });
            } else {
                response.text().then(text => alert(text));
            }
        });
    }

    function filterOrders() {
        const orderId = document.getElementById('searchOrderId').value;
        const orderType = document.getElementById('orderTypeFilter').value;
        fetch(`/logistics-orders?orderId=${orderId}&orderType=${orderType}`)
            .then(response => response.json())
            .then(logisticsOrders => {
                const orderList = document.getElementById('orderList');
                orderList.innerHTML = '';
                logisticsOrders.forEach(logisticsOrder => {
                    const isPurchaseOrder = logisticsOrder.purchaseOrderId !== null;
                    const isSalesOrder = logisticsOrder.salesOrderId !== null;
                    let orderType = '';
                    let customerOrSupplierName = '';
                    let productName = '';
                    let quantity = '';
                    let unitPrice = '';
                    let totalPrice = '';
                    let orderStatus = '';

                    if (isPurchaseOrder) {
                        orderType = '采购订单';
                        const purchaseOrder = logisticsOrder.purchaseOrder;
                        customerOrSupplierName = purchaseOrder.supplier ? purchaseOrder.supplier.name : 'N/A';
                        productName = purchaseOrder.product ? purchaseOrder.product.name : 'N/A';
                        quantity = purchaseOrder.quantity;
                        unitPrice = purchaseOrder.unitPrice;
                        totalPrice = purchaseOrder.totalPrice;
                        orderStatus = purchaseOrder.status;
                    } else if (isSalesOrder) {
                        orderType = '销售订单';
                        const salesOrder = logisticsOrder.salesOrder;
                        customerOrSupplierName = salesOrder.customer ? salesOrder.customer.name : 'N/A';
                        productName = salesOrder.product ? salesOrder.product.name : 'N/A';
                        quantity = salesOrder.quantity;
                        unitPrice = salesOrder.unitPrice;
                        totalPrice = salesOrder.totalPrice;
                        orderStatus = salesOrder.status;
                    }

                    const orderItem = document.createElement('div');
                    orderItem.className = 'order-item';
                    orderItem.innerHTML = `
                            <div>
                                <span>${logisticsOrder.logisticsOrderId}</span>
                                <span>${orderType}</span>
                                <span>${customerOrSupplierName}</span>
                                <span>${productName}</span>
                                <span>${quantity}</span>
                                <span>${unitPrice}</span>
                                <span>${totalPrice}</span>
                                <span>${logisticsOrder.status}</span>
                                <span>${orderStatus}</span>
                                <span>
                                    ${isPurchaseOrder && logisticsOrder.status === '2' ? `<button class="btn" onclick="confirmReceipt(${logisticsOrder.logisticsOrderId}, ${logisticsOrder.purchaseOrderId})">签收</button>` : ''}
                                </span>
                            </div>
                        `;
                    orderList.appendChild(orderItem);
                });
            })
            .catch(error => console.error('Error filtering logistics orders:', error));
    }
</script>
</body>
</html>