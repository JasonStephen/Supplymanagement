<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>订单管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">
<h1>订单管理</h1>
<a th:href="@{/}" class="btn btn-secondary mb-3">返回首页</a>

<!-- 列出所有物流订单 -->
<table class="table table-striped mt-4">
    <thead>
    <tr>
        <th>物流订单ID</th>
        <th>订单类型</th>
        <th>客户/供应商</th>
        <th>产品</th>
        <th>数量</th>
        <th>单价</th>
        <th>总价</th>
        <th>物流状态</th>
        <th>订单状态</th>
        <th>操作</th>
    </tr>
    </thead>
    <tbody id="orderTableBody">
    <!-- 动态生成 -->
    </tbody>
</table>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/logistics-orders')
            .then(response => response.json())
            .then(logisticsOrders => {
                const tableBody = document.getElementById('orderTableBody');
                tableBody.innerHTML = '';
                logisticsOrders.forEach(logisticsOrder => {
                    const isPurchaseOrder = logisticsOrder.purchaseOrderId !== null;
                    const isSalesOrder = logisticsOrder.salesOrderId !== null;
                    let orderType = '';
                    let customerOrSupplierName = '';
                    let productName = '';
                    let quantity = '';
                    let unitPrice = '';
                    let totalPrice = '';
                    let orderStatus = '';

                    if (isPurchaseOrder) {
                        orderType = '采购订单';
                        const purchaseOrder = logisticsOrder.purchaseOrder;
                        customerOrSupplierName = purchaseOrder.supplier ? purchaseOrder.supplier.name : 'N/A';
                        productName = purchaseOrder.product ? purchaseOrder.product.name : 'N/A';
                        quantity = purchaseOrder.quantity;
                        unitPrice = purchaseOrder.unitPrice;
                        totalPrice = purchaseOrder.totalPrice;
                        orderStatus = purchaseOrder.status;
                    } else if (isSalesOrder) {
                        orderType = '销售订单';
                        const salesOrder = logisticsOrder.salesOrder;
                        customerOrSupplierName = salesOrder.customer ? salesOrder.customer.name : 'N/A';
                        productName = salesOrder.product ? salesOrder.product.name : 'N/A';
                        quantity = salesOrder.quantity;
                        unitPrice = salesOrder.unitPrice;
                        totalPrice = salesOrder.totalPrice;
                        orderStatus = salesOrder.status;
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${logisticsOrder.logisticsOrderId}</td>
                        <td>${orderType}</td>
                        <td>${customerOrSupplierName}</td>
                        <td>${productName}</td>
                        <td>${quantity}</td>
                        <td>${unitPrice}</td>
                        <td>${totalPrice}</td>
                        <td>${logisticsOrder.status}</td>
                        <td>${orderStatus}</td>
                        <td>
                            ${isPurchaseOrder && logisticsOrder.status === '2' ? `<button class="btn btn-primary" onclick="confirmReceipt(${logisticsOrder.logisticsOrderId}, ${logisticsOrder.purchaseOrderId})">签收</button>` : ''}
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            })
            .catch(error => console.error('Error fetching logistics orders:', error));
    });

    function confirmReceipt(logisticsOrderId, purchaseOrderId) {
        fetch(`/logistics-orders/${logisticsOrderId}/confirm-receipt`, {
            method: 'POST'
        }).then(response => {
            if (response.ok) {
                fetch(`/purchase-orders/${purchaseOrderId}/confirm-receipt`, {
                    method: 'POST'
                }).then(() => {
                    window.location.reload();
                });
            } else {
                response.text().then(text => alert(text));
            }
        });
    }
</script>
</body>
</html>