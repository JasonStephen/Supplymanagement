<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>产品管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">
<h1>产品管理</h1>
<a th:href="@{/}" class="btn btn-secondary mb-3">返回首页</a>
<a th:href="@{/material}" class="btn btn-secondary mb-3">切换到材料管理</a>
<a th:href="@{/product-category}" class="btn btn-secondary mb-3">切换到产品类别管理</a>

<table class="table table-bordered">
    <thead>
    <tr>
        <th>ID</th>
        <th>名称</th>
        <th>描述</th>
        <th>类别</th>
        <th>价格</th>
        <th>操作</th>
    </tr>
    </thead>
    <tbody id="productTableBody">
    <!-- 动态生成 -->
    </tbody>
</table>

<button class="btn btn-success" onclick="showAddProductForm()">添加产品</button>

<!-- 添加/编辑产品表单 -->
<div id="productForm" style="display:none;">
    <h2 id="formTitle">添加产品</h2>
    <form id="productFormElement">
        <input type="hidden" id="productId">
        <div class="mb-3">
            <label for="name" class="form-label">名称</label>
            <input type="text" class="form-control" id="name" required>
        </div>
        <div class="mb-3">
            <label for="description" class="form-label">描述</label>
            <textarea class="form-control" id="description" required></textarea>
        </div>
        <div class="mb-3">
            <label for="category" class="form-label">类别</label>
            <select class="form-control" id="category">
                <option value="">无</option>
                <!-- 动态生成 -->
            </select>
        </div>
        <div class="mb-3">
            <label for="price" class="form-label">价格</label>
            <input type="number" class="form-control" id="price" required>
        </div>
        <button type="submit" class="btn btn-primary">保存</button>
        <button type="button" class="btn btn-secondary" onclick="hideProductForm()">取消</button>
    </form>
</div>

<!-- 管理配方表单 -->
<div id="productMaterialsForm" style="display:none;">
    <h2>管理配方</h2>
    <table class="table table-bordered">
        <thead>
        <tr>
            <th>材料名称</th>
            <th>数量</th>
            <th>单位</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody id="productMaterialsTable">
        <!-- 动态生成 -->
        </tbody>
    </table>
    <button class="btn btn-success" onclick="showAddProductMaterialForm()">添加配方</button>
    <button class="btn btn-secondary" onclick="hideProductMaterialsForm()">关闭</button>
</div>

<!-- 添加/编辑配方表单 -->
<div id="productMaterialForm" style="display:none;">
    <h2 id="productMaterialFormTitle">添加配方</h2>
    <form id="productMaterialFormElement">
        <input type="hidden" id="productMaterialId">
        <div class="mb-3">
            <label for="material" class="form-label">材料</label>
            <select class="form-control" id="material" required>
                <!-- 动态生成 -->
            </select>
        </div>
        <div class="mb-3">
            <label for="quantity" class="form-label">数量</label>
            <input type="number" class="form-control" id="quantity" required>
        </div>
        <div class="mb-3">
            <label for="unit" class="form-label">单位</label>
            <input type="text" class="form-control" id="unit" required>
        </div>
        <button type="submit" class="btn btn-primary">保存</button>
        <button type="button" class="btn btn-secondary" onclick="hideProductMaterialForm()">取消</button>
    </form>
</div>

<script>
    let currentProductId = null;

    document.addEventListener('DOMContentLoaded', function() {
        fetch('/products')
            .then(response => response.json())
            .then(products => {
                const tableBody = document.getElementById('productTableBody');
                tableBody.innerHTML = '';
                products.forEach(product => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${product.productId}</td>
                        <td>${product.name}</td>
                        <td>${product.description}</td>
                        <td>${product.category ? product.category.categoryName : '无'}</td>
                        <td>${product.price}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editProduct(${product.productId})">编辑</button>
                            <button class="btn btn-danger" onclick="deleteProduct(${product.productId})">删除</button>
                            <button class="btn btn-info" onclick="manageProductMaterials(${product.productId})">管理配方</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            });

        fetch('/product-categories')
            .then(response => response.json())
            .then(categories => {
                const categorySelect = document.getElementById('category');
                categorySelect.innerHTML = '<option value="">无</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.categoryId;
                    option.text = category.categoryName;
                    categorySelect.appendChild(option);
                });
            });

        fetch('/materials')
            .then(response => response.json())
            .then(materials => {
                const materialSelect = document.getElementById('material');
                materialSelect.innerHTML = '';
                materials.forEach(material => {
                    const option = document.createElement('option');
                    option.value = material.materialId;
                    option.text = material.name;
                    materialSelect.appendChild(option);
                });
            });
    });

    function showAddProductForm() {
        document.getElementById('formTitle').innerText = '添加产品';
        document.getElementById('productFormElement').reset();
        document.getElementById('productId').value = '';
        document.getElementById('productForm').style.display = 'block';
    }

    function hideProductForm() {
        document.getElementById('productForm').style.display = 'none';
    }

    function editProduct(id) {
        fetch(`/products/${id}`)
            .then(response => response.json())
            .then(product => {
                document.getElementById('formTitle').innerText = '编辑产品';
                document.getElementById('productId').value = product.productId;
                document.getElementById('name').value = product.name;
                document.getElementById('description').value = product.description;
                document.getElementById('category').value = product.category ? product.category.categoryId : '';
                document.getElementById('price').value = product.price;
                document.getElementById('productForm').style.display = 'block';
            });
    }

    function deleteProduct(id) {
        fetch(`/products/${id}`, {
            method: 'DELETE'
        }).then(() => {
            window.location.reload();
        });
    }

    function manageProductMaterials(productId) {
        currentProductId = productId;
        console.log('Managing Product ID:', productId);

        fetch(`/product-materials/product/${productId}`)
            .then(response => response.json())
            .then(productMaterials => {
                const table = document.getElementById('productMaterialsTable');
                table.innerHTML = '';
                productMaterials.forEach(pm => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${pm.material.name}</td>
                    <td>${pm.quantity}</td>
                    <td>${pm.unit}</td>
                    <td>
                        <button class="btn btn-primary" onclick="editProductMaterial(${productId}, ${pm.material.materialId})">编辑</button>
                        <button class="btn btn-danger" onclick="deleteProductMaterial(${productId}, ${pm.material.materialId})">删除</button>
                    </td>
                `;
                    table.appendChild(row);
                });
                document.getElementById('productMaterialsForm').style.display = 'block';
            });
    }

    function hideProductMaterialsForm() {
        document.getElementById('productMaterialsForm').style.display = 'none';
    }

    function showAddProductMaterialForm() {
        document.getElementById('productMaterialFormTitle').innerText = '添加配方';
        document.getElementById('productMaterialFormElement').reset();
        document.getElementById('productMaterialId').value = '';
        document.getElementById('productMaterialForm').style.display = 'block';
    }

    function hideProductMaterialForm() {
        document.getElementById('productMaterialForm').style.display = 'none';
    }

    function editProductMaterial(productId, materialId) {
        fetch(`/product-materials/product/${productId}/material/${materialId}`)
            .then(response => response.json())
            .then(pm => {
                document.getElementById('productMaterialFormTitle').innerText = '编辑配方';
                document.getElementById('productMaterialId').value = pm.productMaterialId;
                document.getElementById('material').value = pm.material.materialId;
                document.getElementById('quantity').value = pm.quantity;
                document.getElementById('unit').value = pm.unit;
                document.getElementById('productMaterialForm').style.display = 'block';
            });
    }

    function deleteProductMaterial(productId, materialId) {
        fetch(`/product-materials/product/${productId}/material/${materialId}`, {
            method: 'DELETE'
        }).then(() => {
            window.location.reload();
        });
    }

    document.getElementById('productFormElement').addEventListener('submit', function(event) {
        event.preventDefault();
        const id = document.getElementById('productId').value;
        const name = document.getElementById('name').value;
        const description = document.getElementById('description').value;
        const category = document.getElementById('category').value;
        const price = document.getElementById('price').value;

        const method = id ? 'PUT' : 'POST';
        const url = id ? `/products/${id}` : '/products';

        const data = { name, description, price };
        if (category) {
            data.category = { categoryId: category };
        }

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        }).then(() => {
            window.location.reload();
        });
    });

    document.getElementById('productMaterialFormElement').addEventListener('submit', function(event) {
        event.preventDefault();
        const productId = currentProductId;
        const materialId = document.getElementById('material').value;
        const quantity = document.getElementById('quantity').value;
        const unit = document.getElementById('unit').value;

        console.log('Product ID:', productId);
        console.log('Material ID:', materialId);
        console.log('Quantity:', quantity);
        console.log('Unit:', unit);

        if (!materialId) {
            alert("Material cannot be null");
            return;
        }

        const method = 'POST';
        const url = `/product-materials`;

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ product: { productId }, material: { materialId }, quantity, unit })
        }).then(() => {
            window.location.reload();
        });
    });
</script>
</body>
</html>