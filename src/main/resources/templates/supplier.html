<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>供应商管理</title>
    <link th:href="@{/css/rolepermission.css}" rel="stylesheet">
    <link th:href="@{/css/sidebar.css}" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/navigation-bar.css}">
    <script th:src="@{/js/navigation-bar.js}"></script>
    <script th:src="@{/js/sidebar.js}"></script>
</head>
<body>
<div th:replace="~{fragments/navigation-bar :: navigation-bar}"></div>
<div class="container">
    <div class="menu-icon" onclick="toggleSidebar()">☰</div>
    <!-- 侧边栏 -->
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <!-- 右侧内容区 -->
    <div class="content">
        <h1>供应商管理</h1>
        <button class="btn btn-primary mb-3" onclick="showAddModal()">添加供应商</button>

        <div class="mt-4">
            <h2>供应商列表</h2>
            <ul id="supplierList" class="list-group"></ul>
        </div>

        <!-- 添加/编辑供应商模态框 -->
        <div id="supplierModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2 id="modalTitle">添加供应商</h2>
                <form id="supplierForm">
                    <input type="hidden" id="editSupplierId">
                    <div class="mb-3">
                        <label for="supplierName" class="form-label">供应商名称:</label>
                        <input type="text" id="supplierName" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="contactPerson" class="form-label">联系人:</label>
                        <input type="text" id="contactPerson" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">电话:</label>
                        <input type="text" id="phone" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label">地址:</label>
                        <input type="text" id="address" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary">保存</button>
                </form>
            </div>
        </div>

        <!-- 删除确认模态框 -->
        <div id="deleteConfirmationModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeDeleteModal()">&times;</span>
                <h2>确认删除</h2>
                <p>您确定要删除此供应商吗？</p>
                <div class="modal-actions">
                    <button class="btn btn-danger" onclick="confirmDelete()">确认删除</button>
                    <button class="btn btn-secondary" onclick="closeDeleteModal()">取消</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    let currentDeleteId = null; // 用于暂存待删除的供应商ID

    // 显示添加模态框
    function showAddModal() {
        closeModal(); // 确保清空历史状态
        document.getElementById('modalTitle').textContent = '添加供应商';
        document.getElementById('supplierModal').style.display = 'block';
    }

    // 显示编辑模态框并回填数据
    function editSupplier(supplierId) {
        fetch(`/suppliers/${supplierId}`)
            .then(response => response.json())
            .then(supplier => {
                document.getElementById('modalTitle').textContent = '编辑供应商';
                document.getElementById('editSupplierId').value = supplier.supplierId;
                document.getElementById('supplierName').value = supplier.name;
                document.getElementById('contactPerson').value = supplier.contactPerson;
                document.getElementById('phone').value = supplier.phone;
                document.getElementById('address').value = supplier.address;
                document.getElementById('supplierModal').style.display = 'block';
            });
    }

    // 关闭模态框
    function closeModal() {
        document.getElementById('supplierModal').style.display = 'none';
        document.getElementById('supplierForm').reset();
        document.getElementById('editSupplierId').value = ''; // 清空隐藏的 ID
    }

    // 删除确认弹窗
    function showDeleteConfirmation(supplierId) {
        currentDeleteId = supplierId;
        document.getElementById('deleteConfirmationModal').style.display = 'block';
    }

    function closeDeleteModal() {
        document.getElementById('deleteConfirmationModal').style.display = 'none';
    }

    function confirmDelete() {
        if (currentDeleteId) {
            fetch(`/suppliers/${currentDeleteId}`, {
                method: 'DELETE'
            }).then(() => {
                window.location.reload();
                closeDeleteModal();
            });
        }
    }

    // 表单提交处理
    document.getElementById('supplierForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const supplierId = document.getElementById('editSupplierId').value;
        const url = supplierId ? `/suppliers/${supplierId}` : '/suppliers';
        const method = supplierId ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: document.getElementById('supplierName').value,
                contactPerson: document.getElementById('contactPerson').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value
            })
        }).then(() => {
            window.location.reload();
        });
    });

    // 列表渲染
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/suppliers/list')
            .then(response => response.json())
            .then(suppliers => {
                const list = document.getElementById('supplierList');
                list.innerHTML = '';
                suppliers.forEach(supplier => {
                    const item = document.createElement('li');
                    item.className = 'list-group-item';
                    item.innerHTML = `
                        ${supplier.name} - ${supplier.contactPerson} - ${supplier.phone} - ${supplier.address}
                        <div class="btn-container">
                            <button class="btn btn-warning" onclick="editSupplier(${supplier.supplierId})">编辑</button>
                            <button class="btn btn-danger" onclick="showDeleteConfirmation(${supplier.supplierId})">删除</button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            });
    });
</script>
</body>
</html>
