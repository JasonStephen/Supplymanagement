<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>生产管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">
<h1>生产管理</h1>
<a th:href="@{/}" class="btn btn-secondary mb-3">返回首页</a>

<!-- 选择产品 -->
<div class="mb-3">
    <label for="productSelect" class="form-label">选择产品:</label>
    <select id="productSelect" class="form-select" onchange="loadProductComponents()">
        <!-- 动态生成 -->
    </select>
</div>

<!-- 显示配方和最大可生产数量 -->
<div id="productComponentsDiv" style="display:none;">
    <h2>配方</h2>
    <table class="table table-bordered">
        <thead>
        <tr>
            <th>组件名称</th>
            <th>数量</th>
            <th>单位</th>
        </tr>
        </thead>
        <tbody id="productComponentTableBody">
        <!-- 动态生成 -->
        </tbody>
    </table>
    <div class="mb-3">
        <label for="maxProductionQuantity" class="form-label">最大可生产数量:</label>
        <input type="number" id="maxProductionQuantity" class="form-control" readonly>
    </div>
    <div class="mb-3">
        <label for="productionQuantity" class="form-label">生产数量:</label>
        <input type="number" id="productionQuantity" class="form-control" min="1" oninput="validateProductionQuantity()">
    </div>
    <button class="btn btn-primary" onclick="produceProduct()">生产</button>
    <div id="error-message" style="color: red; display: none;">材料不足，无法生产。</div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadProducts();
    });

    function loadProducts() {
        fetch('/products')
            .then(response => response.json())
            .then(products => {
                const productSelect = document.getElementById('productSelect');
                productSelect.innerHTML = '';
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.productId;
                    option.text = product.name;
                    productSelect.appendChild(option);
                });
            });
    }

    function loadProductComponents() {
        const productId = document.getElementById('productSelect').value;
        fetch(`/products/${productId}/components`)
            .then(response => response.json())
            .then(components => {
                const tableBody = document.getElementById('productComponentTableBody');
                tableBody.innerHTML = '';
                let maxProductionQuantity = Infinity;
                components.forEach(component => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${component.component.name}</td>
                        <td>${component.quantity}</td>
                        <td>${component.unit}</td>
                    `;
                    tableBody.appendChild(row);
                    fetch(`/inventory/${component.component.productId}`)
                        .then(response => response.json())
                        .then(inventory => {
                            const maxQuantity = Math.floor(inventory.quantity / component.quantity);
                            if (maxQuantity < maxProductionQuantity) {
                                maxProductionQuantity = maxQuantity;
                            }
                            document.getElementById('maxProductionQuantity').value = maxProductionQuantity;
                        });
                });
                document.getElementById('productComponentsDiv').style.display = 'block';
            });
    }

    function validateProductionQuantity() {
        const maxQuantity = parseInt(document.getElementById('maxProductionQuantity').value, 10);
        const productionQuantityInput = document.getElementById('productionQuantity');
        let productionQuantity = parseInt(productionQuantityInput.value, 10);

        if (isNaN(productionQuantity) || productionQuantity < 1) {
            productionQuantityInput.value = 1;
        } else if (productionQuantity > maxQuantity) {
            productionQuantityInput.value = maxQuantity;
        }
    }

    function produceProduct() {
        const productId = document.getElementById('productSelect').value;
        const productionQuantity = document.getElementById('productionQuantity').value;
        const userId = [[${user != null ? user.userId : 'null'}]];

        fetch(`/products/${productId}/produce`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ quantity: productionQuantity, userId: userId })
        }).then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                document.getElementById('error-message').style.display = 'block';
            }
        });
    }
</script>
</body>
</html>